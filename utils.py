"""
–í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏
"""
from aiogram import Bot
from loguru import logger
import keyboards
import database


async def notify_user_order_status_changed(bot: Bot, order: dict, status_name: str):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–± –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–∫–∞–∑–∞"""
    try:
        user_id = order['user_id']
        order_id = order['id']
        
        # –§–æ—Ä–º–∏—Ä—É–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å—Ç–∞—Ç—É—Å–∞
        if status_name == "–ì–æ—Ç–æ–≤":
            message = (
                f"‚úÖ –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ{order_id} –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ!\n\n"
                "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–±—Ä–∞—Ç—å –≤–∞—à –∑–∞–∫–∞–∑. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ó–∞–±—Ä–∞–ª' –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è."
            )
            # –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É "–ó–∞–±—Ä–∞–ª" –¥–ª—è –≥–æ—Ç–æ–≤—ã—Ö –∑–∞–∫–∞–∑–æ–≤
            await bot.send_message(
                user_id, 
                message,
                reply_markup=keyboards.get_order_detail_keyboard(order_id, "ready", is_admin=False)
            )
        elif status_name == "–û—Ç–∫–ª–æ–Ω–µ–Ω":
            rejection_reason = order.get('rejection_reason', '–ù–µ —É–∫–∞–∑–∞–Ω–∞')
            message = (
                f"‚ùå –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ{order_id} –æ—Ç–∫–ª–æ–Ω–µ–Ω.\n\n"
                f"–ü—Ä–∏—á–∏–Ω–∞ –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏—è: {rejection_reason}"
            )
            await bot.send_message(user_id, message)
        else:
            message = f"üìã –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ{order_id} –ø–µ—Ä–µ–≤–µ–¥–µ–Ω –≤ —Å—Ç–∞—Ç—É—Å '{status_name}'."
            await bot.send_message(user_id, message)
        
        logger.info(f"–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} –æ –∑–∞–∫–∞–∑–µ ‚Ññ{order_id}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è: {e}")


async def send_reminder_about_ready_order(bot: Bot, order: dict):
    """–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ –≥–æ—Ç–æ–≤–æ–º –∑–∞–∫–∞–∑–µ"""
    try:
        user_id = order['user_id']
        order_id = order['id']
        
        message = (
            f"üîî –ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ: –í–∞—à –∑–∞–∫–∞–∑ ‚Ññ{order_id} –≥–æ—Ç–æ–≤ –∫ –≤—ã–¥–∞—á–µ!\n\n"
            "–ù–µ –∑–∞–±—É–¥—å—Ç–µ –∑–∞–±—Ä–∞—Ç—å –≤–∞—à –∑–∞–∫–∞–∑. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É '–ó–∞–±—Ä–∞–ª' –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è."
        )
        
        await bot.send_message(
            user_id,
            message,
            reply_markup=keyboards.get_order_detail_keyboard(order_id, "ready", is_admin=False)
        )
        
        # –û–±–Ω–æ–≤–ª—è–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è
        await database.db.update_last_reminder_time(order_id)
        
        logger.info(f"–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é {user_id} –æ –∑–∞–∫–∞–∑–µ ‚Ññ{order_id}")
        
    except Exception as e:
        logger.error(f"–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è: {e}")

